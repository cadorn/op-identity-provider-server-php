<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<title>LinkedIn Profile Page</title>

<meta name="viewport" content="minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta charset="UTF-8">
<script src="http://connect.facebook.net/en_US/all.js"></script>

<script type="text/javascript" src="/js/lib/jquery/jquery-1.8.3.min.js"></script>

<!-- script type="text/javascript" src="lib/importcss.js"></script -->
<script language="javascript" type="text/javascript">
//init fb api
FB.init({
	//example.unstable.hookflash.me
	appId: '398774746863445',
	status: true,
	cookie: true,
	oauth: true,
	xfbml: true
});  

//window.fbAsyncInit = function() {
    // init the FB JS SDK
//    FB.init({
//      appId      : '483549165003620', // App ID from the App Dashboard
//      channelUrl : 'example.unstable.hookflash.me/channel.html', // Channel File for x-domain communication
//      status     : true, // check the login status upon init?
//      cookie     : true, // set sessions cookies to allow your server to access the session?
//      xfbml      : true  // parse XFBML tags on this page?
//    });

    // Additional initialization code such as adding Event Listeners goes here

//  };
function onStatus(response) {
	if (response.status === 'connected') {
		//logged in
		getMyFBProfile(); 
	}else if (status == 'unknown'){
		
	}
	else{
		//handle fb not logged in
		//alert('not logged in');
	}
}

//subscribe to fb auth status
FB.getLoginStatus(function(response) {
	onStatus(response); 
	FB.Event.subscribe('auth.statusChange', onStatus); 
});

var allFriends  = new Array();
var defaultImage = "images/icon_no_photo_no_border_80x80.png";

//get my profile data
function getMyFBProfile(){
	//alert('before getMyFBProfile');
	FB.api("/me?fields=id,name,picture", handleMe);
}

//handle returned my fb profile
function handleMe(response){
	//Send data to client
	//alert(' handleMe');
	var iframe = document.createElement("IFRAME");
	var image =  defaultImage;
	if ((response.picture != undefined) && (response.picture.data != undefined) && (response.picture.data.url != undefined))
	{
		image = response.picture.data.url;
	}
	var myProfile = {"id": response.id, "fullName": response.name, "pictureUrl": image};
	var profile = JSON.stringify(myProfile);
	var locationProtocol = "";
	if (location.protocol === 'https:'){
		locationProtocol = "https:";
	} else {
		locationProtocol = "http:";
	}
	//iframe.setAttribute("src", "hookflash-js-frame:proccessMyFBProfile:" + profile);
	iframe.setAttribute("src", locationProtocol + "//datapass.hookflash.me/?method=proccessMyFBProfile;data=" + profile);
	document.documentElement.appendChild(iframe);
	iframe.parentNode.removeChild(iframe);
	iframe = null;
	//continue
	getAllFacebookIDs();
}

//get list of my fb friends
function getAllFacebookIDs(){
	//alert(' getAllFacebookIDs');
	FB.api("/me/friends?fields=id,name,picture", handleIDs);
}

//function getAllFacebookIDsSince(since){
//	since = 1346236129;
//	FB.api("/me/friends?fields=id,name,picture&since="+since, handleIDsSince);
//}
//
//function getAllFacebookIDsAfter(after){
//	after = 100000654968420;
//	FB.api("/me/friends?fields=id,name,picture&after+id="+after, handleIDsSince);
//}

//handle returned my fb friends
function handleIDs(response){
	//alert(' handleIDs 1');
	for (var i=0; i < response.data.length; i++){
		var current =  response.data[i];
		var image =  defaultImage;
		if ((current.picture != undefined) && (current.picture.data != undefined) && (current.picture.data.url != undefined))
		{
			image = current.picture.data.url;
		}
		allFriends.push({"id": current.id,
						 "fullName": current.name,
						 "pictureUrl": image});
	}
	//if there is no contacts
	var next;
	if (response.paging !== undefined){
		next = response.paging.next;
	}
		
	if (next !== undefined){
		//one more request
		//FB.api(next, handleIDs);
		$.getJSON(next, handleIDs);
	}else{
		//alert(' handleIDs 2');
		var allFriendsString = JSON.stringify(allFriends);
		var iframe = document.createElement("IFRAME");
		var locationProtocol = "";
		if (location.protocol === 'https:'){
			locationProtocol = "https:";
		} else {
			locationProtocol = "http:";
		}
		//iframe.setAttribute("src", "hookflash-js-frame:proccessFbFriends:" + allFriendsString);
		iframe.setAttribute("src", locationProtocol + "//datapass.hookflash.me/?method=proccessFbFriends;data=" + allFriendsString);
		document.documentElement.appendChild(iframe);
		iframe.parentNode.removeChild(iframe);
		iframe = null;
		allFriends.length = 0;
	}
}

</script>

</head>

<body>
	<button onclick="getMyFBProfile()" value="ooo">get my FB Profile</button>
	<button onclick="getAllFacebookIDs()" value="ooo">Get all</button>
	
	<a href="#" onclick="FB.login(function(response){},{perms:'email,publish_stream,read_stream'});">add permissions</a>

</body>
</html>
